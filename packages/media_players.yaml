#####################################################################
#    @package          :     media_players
#    @description      :     media players
#####################################################################
homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################
    package.node_anchors:
      customize: &customize
        package: 'living_room_media'

      hidden: &hidden
        <<: *customize
        hidden: true


    ################################################
    ## Media Player
    ################################################
    media_player.kodi_living_room:
      friendly_name: "Living Room Kodi"

    media_player.kodi_bedroom:
      friendly_name: "Bedroom Kodi"

    media_player.apple_tv:
      friendly_name: "Apple TV"

#    media_player.firetv_living_room:
#      friendly_name: "FireTV"

#    media_player.rnmcast:
#      friendly_name: "Chromecast"

#    media_player.kodi_office:
#      friendly_name: "Office Kodi"

    ################################################
    ## Input Select
    ################################################
    input_select.living_room_tv_input:
      icon: mdi:television

    input_select.onkyo_amp_input:
      icon: mdi:radio

    ################################################
    ## Script
    ################################################
    script.tv_power_off:
      friendly_name: "TV Shutdown"
      icon: mdi:power


#####################################################################
### Media Player
#####################################################################
media_player:
  - platform: kodi
    host: !secret kodi_living_room
    port: !secret kodi_other_port
    name: kodi_living_room
    username: !secret kodi_user
    password: !secret kodi_password

  - platform: kodi
    host: !secret kodi_bedroom
    port: !secret kodi_port
    name: kodi_bedroom
    username: !secret kodi_user
    password: !secret kodi_password

  - platform: apple_tv
    host: !secret appletv_host
    login_id: !secret appletv_login_id
    name: "Apple TV"
    start_off: false
    credentials: !secret appletv_creds

#  - platform: firetv
##    host: !secret firetv_host
#    name: FireTV
#    device: firetv_living_room

#  - platform: kodi
#    host: !secret kodi_office
#    port: !secret kodi_port
#    name: kodi_office
#    username: !secret kodi_user
#    password: !secret kodi_password


#####################################################################
### Input Select
#####################################################################
input_select:
  living_room_tv_input:
    name: Living Room TV Input
    initial: "Select an option..."
    options:
      - "Select an option..."
      - "DirecTV"
      - "FireTV"
      - "Chromecast"

  onkyo_amp_input:
    name: Onkyo Amp Input
    initial: "Select an option..."
    options:
      - "Select an option..."
      - "TV"
      - "Movie"
      - "DVD"
      - "iPod"


#####################################################################
### Script
#####################################################################
script:
  tv_power_off:
    sequence:

    - service: switch.turn_off
      entity_id: switch.tv_power

    - service: switch.turn_off
      entity_id: switch.directv_power


#####################################################################
### Automation
#####################################################################
automation:
#  ### Set Kodi scene when media is playing
#  - alias: Kodi Scene Set
#    initial_state: 'on'
#    trigger:
#      - platform: state
#        entity_id: media_player.kodi_living_room
#
#    condition: 
#      - condition: state
#        entity_id: sun.sun
#        state: 'below_horizon'
#
#      - condition: state
#        entity_id: input_boolean.dinner_time
#        state: 'off'
#
#    action:
#      - service: scene.turn_on
#        data_template:
#          entity_id: >-
#            {% if trigger.to_state.state == "playing" or trigger.to_state.state == "resumed" %}
#              scene.movie_time
#            {% elif trigger.to_state.state == "paused" or trigger.to_state.state == "idle" %}
#              scene.movie_paused
#            {% elif trigger.to_state.state == "stopped" or trigger.to_state.state == "ended" %}
#              scene.movie_ended
#            {% else %}
#              scene.evening
#            {% endif %}

  ### Set Lighting scene when media is playing on Apple TV
  - alias: AppleTV Scene Set
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id: media_player.apple_tv

    condition: 
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'

      - condition: state
        entity_id: input_boolean.dinner_time
        state: 'off'

    action:
      - service: scene.turn_on
        data_template:
          entity_id: >-
            {% if trigger.to_state.state == "playing" or trigger.to_state.state == "resumed" %}
              scene.movie_time
            {% else %}
              scene.evening
            {% endif %}

  ### Living Room TV Input Select
  - alias: Living Room TV Select Input
    initial_state: 'on'
    hide_entity: true
    trigger:
      - platform: state
        entity_id: input_select.living_room_tv_input

    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select an option...' }}"

    action:
      - service: switch.turn_on
        data_template:
          entity_id: "switch.tv_input_{{ trigger.to_state.state|lower }}"

# Reset the Input Select to "Select an option..."
      - service: input_select.select_option
        data_template:
          entity_id: "{{ trigger.to_state.entity_id }}"
          option: Select an option...

  ### Living Room Onkyo Input Select
  - alias: Living Room Amp Input Select
    initial_state: 'on'
    hide_entity: true
    trigger:
      - platform: state
        entity_id: input_select.onkyo_amp_input

    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state != 'Select an option...' }}"

    action:
      - service: switch.turn_on
        data_template:
          entity_id: "switch.amp_input_{{ trigger.to_state.state|lower }}"

# Reset the Input Select to "Select an option..."
      - service: input_select.select_option
        data_template:
          entity_id: "{{ trigger.to_state.entity_id }}"
          option: Select an option...
