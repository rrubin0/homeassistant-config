#####################################################################
### Control Visitor Mode for dog sitter
#####################################################################
automation:
  - alias: Enable Visitor Mode
    initial_state: 'on'
     
    trigger:
      - platform: template
        value_template: "{{ states('sensor.lock_south_door_status') == 'Unlocked by Dog Sitter' }}"

    condition:
      - condition: state
        entity_id: group.all_devices
        state: 'not_home'

      - condition: state
        entity_id: input_boolean.visitor_mode
        state: 'off'

    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.visitor_mode


  ### Cancel Visitor Mode when we return home
  - alias: Cancel Visitor Mode
    initial_state: 'on'
     
    trigger:
      - platform: state
        entity_id: group.all_devices
        from: 'not_home'
        to: 'home'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id: input_boolean.visitor_mode
        state: 'on'

    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.visitor_mode


  ### Start Away Mode if visitor_mode is turned off
  - alias: Visitor Away
    initial_state: 'on'
     
    trigger:
      - platform: state
        entity_id: input_boolean.visitor_mode
        to: 'off'

    condition:
      - condition: state
        entity_id: group.all_devices
        state: 'not_home'

    action:
      - service: timer.start
        entity_id: timer.away_mode